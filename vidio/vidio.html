<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ðŸŽ¬ Video Streamer</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    /* ==================================
       DESAIN BARU - PROFESIONAL & MODERN
       ================================== */

    /* 1. VARIABEL & DASAR */
    :root {
      --bg-color: #0c0c0e;
      --surface-color: rgba(26, 26, 26, 0.7);
      --surface-solid: #1a1a1a;
      --border-color: rgba(60, 60, 60, 0.8);
      --text-primary: #f5f5f5;
      --text-secondary: #a0a0a0;
      --accent-primary: #3b82f6; /* Biru */
      --accent-secondary: #10b981; /* Hijau */
      --accent-warning: #f59e0b;  /* Kuning */
      --accent-danger: #ef4444;   /* Merah */
      --shadow-color: rgba(0, 0, 0, 0.5);
      --shadow-strong: 0 10px 35px var(--shadow-color);
      --focus-ring: 0 0 0 3px rgba(59, 130, 246, 0.6);
      --font-family: 'Inter', system-ui, -apple-system, sans-serif;
      --border-radius: 12px;
      --transition-fast: 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg-color); }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #555; }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    html { scroll-behavior: smooth; }

    body {
      font-family: var(--font-family);
      background-color: var(--bg-color);
      color: var(--text-primary);
      padding: 2rem 1rem;
      padding-bottom: 80px;
    }

    /* Latar Belakang PNG Samar */
    body::before {
      content: "";
      position: fixed;
      inset: 0;
      z-index: -1;
      background-image: url('background.png');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      opacity: 0.08;
      filter: blur(100px);
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      display: grid;
      gap: 2rem;
    }

    /* 2. HEADER & INPUT */
    .header-card {
      background: var(--surface-color);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      padding: 1.5rem;
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      box-shadow: var(--shadow-strong);
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    h1 {
      text-align: center;
      font-size: clamp(1.8rem, 5vw, 2.5rem);
      font-weight: 700;
      text-shadow: 2px 2px 8px var(--shadow-color);
      margin-bottom: 0.5rem;
      background: -webkit-linear-gradient(45deg, var(--accent-primary), var(--text-primary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    /* Tata Letak Input dan Tombol Aksi */
    .action-bar {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        align-items: stretch;
    }
    
    .inputs {
      display: flex;
      flex: 1 1 500px; /* Lebar fleksibel, basis 500px */
      gap: 0.75rem;
    }
    
    .inputs input {
      width: 100%;
      min-width: 150px;
      padding: 0.8rem 1rem;
      border-radius: var(--border-radius);
      border: 1px solid var(--border-color);
      background: var(--surface-solid);
      color: var(--text-primary);
      font-size: 1rem;
      transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
    }
    .inputs input::placeholder { color: var(--text-secondary); }
    .inputs input:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: var(--focus-ring);
    }
    
    /* Tombol-tombol */
    .controls {
      display: flex;
      gap: 0.75rem;
    }
    
    .controls button {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0.8rem;
      border: 1px solid transparent;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
      color: var(--text-primary);
      transition: all var(--transition-fast);
      aspect-ratio: 1 / 1; /* Membuat tombol menjadi persegi */
    }
    
    .controls button.btn-primary {
        aspect-ratio: auto; /* Tombol utama bisa lebih lebar */
        padding: 0.8rem 1.25rem;
        gap: 0.5rem;
    }
    
    .controls button:hover { transform: translateY(-2px); filter: brightness(1.1); box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
    .controls button:active { transform: translateY(0); }
    .controls button:focus-visible { outline: none; box-shadow: var(--focus-ring); }
    .controls button svg {
        width: 22px;
        height: 22px;
    }

    .btn-primary { background: var(--accent-primary); }
    .btn-secondary-action { background: #334155; border-color: #475569; }
    .btn-secondary-action:hover { border-color: #64748b; }
    

    /* 4. VIDEO PLAYER */
    .video-container {
      background-color: #000;
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-strong);
      position: sticky;
      top: 1rem;
      z-index: 10;
    }
    video {
      display: block;
      width: 100%;
      height: auto;
      max-height: 75vh;
      aspect-ratio: 16 / 9;
    }

    /* 5. PLAYLIST */
    .playlist-container { min-height: 200px; }
    .playlist {
      display: grid;
      gap: 1rem;
    }
    .playlist-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.75rem;
      background: var(--surface-color);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      transition: all var(--transition-fast);
      cursor: grab;
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }
    .playlist-item:hover {
      background: rgba(42, 42, 42, 0.8);
      border-color: var(--accent-primary);
      transform: scale(1.02);
    }
    .playlist-item.is-playing {
        border-color: var(--accent-primary);
        box-shadow: 0 0 15px rgba(59, 130, 246, 0.4);
    }
    .playlist-item.is-dragging {
        opacity: 0.5;
        background: #555;
    }

    .playlist-thumbnail {
      width: 120px;
      height: 68px;
      border-radius: 8px;
      object-fit: cover;
      background: #333;
      flex-shrink: 0;
      border: 1px solid var(--border-color);
      cursor: pointer;
    }
    .playlist-text {
      flex: 1;
      min-width: 0;
      color: var(--text-primary);
      font-size: 1.1rem;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: pointer;
    }
    .actions { display: flex; gap: 0.5rem; }
    .actions button {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      color: #fff;
      transition: all var(--transition-fast);
    }
    .actions button:hover { filter: brightness(1.2); transform: scale(1.1); }
    .actions button:focus-visible { outline: none; box-shadow: var(--focus-ring); }
    .actions svg { width: 18px; height: 18px; }
    .actions .edit { background: var(--accent-warning); color: #000; }
    .actions .delete { background: var(--accent-danger); }
    
    .playlist-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 3rem 1rem;
      border: 2px dashed var(--border-color);
      border-radius: var(--border-radius);
      text-align: center;
      color: var(--text-secondary);
    }
    .playlist-empty-icon { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; }
    .playlist-empty-text { font-size: 1.1rem; }

    /* 6. MODAL UNTUK EDIT/TAMBAH */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(8px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s, visibility 0.3s;
    }
    .modal-overlay.is-visible { opacity: 1; visibility: visible; }
    .modal {
      background: var(--surface-solid);
      padding: 2rem;
      border-radius: 16px;
      width: 90%;
      max-width: 500px;
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-strong);
      transform: scale(0.95);
      transition: transform 0.3s;
    }
    .modal-overlay.is-visible .modal { transform: scale(1); }
    .modal h2 { margin-bottom: 1.5rem; text-align: center; }
    .modal-form .form-group { margin-bottom: 1rem; }
    .modal-form label { display: block; margin-bottom: 0.5rem; color: var(--text-secondary); }
    .modal-form input { width: 100%; }
    .modal-actions {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
      margin-top: 2rem;
    }
    .modal-actions button { min-width: 100px; }
    .btn-secondary { background: #334155; }

    /* 7. NOTIFIKASI TOAST */
    .toast-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 2000;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    .toast {
        padding: 0.8rem 1.2rem;
        border-radius: 8px;
        color: #fff;
        font-weight: 500;
        box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        opacity: 0;
        transform: translateX(100%);
        animation: slideIn 0.3s forwards;
    }
    .toast.success { background-color: var(--accent-secondary); }
    .toast.error { background-color: var(--accent-danger); }
    @keyframes slideIn { to { opacity: 1; transform: translateX(0); } }

    /* 8. FOOTER & UTILITAS */
    footer {
      position: fixed;
      left: 0; right: 0; bottom: 0;
      text-align: center;
      padding: 1rem;
      background: rgba(10, 10, 10, 0.7);
      color: var(--text-secondary);
      font-size: 0.9rem;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-top: 1px solid var(--border-color);
      z-index: 50;
    }
    .hidden { display: none !important; }

    /* 9. RESPONSIVITAS */
    @media (max-width: 768px) {
      body { padding: 1rem 0.5rem 80px; }
      .header-card { padding: 1rem; }
      .playlist-item { flex-direction: column; align-items: stretch; cursor: default; }
      .playlist-thumbnail { width: 100%; height: auto; aspect-ratio: 16/9; margin-bottom: 0.75rem; }
      .playlist-text { text-align: center; margin-bottom: 0.75rem; white-space: normal; }
      .actions { justify-content: center; }
    }
  </style>
</head>
<body>
  
  <div class="container">
    <div class="header-card">
      <h1>ðŸŽ¬ Video Streamer</h1>
      <div class="action-bar">
        <div class="inputs">
            <input type="text" id="videoUrlInput" placeholder="Video...">
            <input type="text" id="subtitleUrlInput" placeholder="Subtitle (opsional)">
        </div>
        <div class="controls">
            <button class="btn-primary" id="addToPlaylistBtn" title="Tambah ke Playlist">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                <span>Tambah</span>
            </button>
            <button class="btn-secondary-action" id="exportPlaylistBtn" title="Simpan Playlist">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
            </button>
            <button class="btn-secondary-action" id="importPlaylistBtn" title="Buka Playlist">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5" /></svg>
            </button>
            <button class="btn-secondary-action" id="loadFromJsonFolderBtn" title="Muat Movie Lokal (file json)">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 9.776c.112-.017.227-.026.344-.026h15.812c.117 0 .232.009.344.026m-16.5 0a2.25 2.25 0 0 0-1.883 2.542l.857 6a2.25 2.25 0 0 0 2.227 1.932H19.5a2.25 2.25 0 0 0 2.227-1.932l.857-6a2.25 2.25 0 0 0-1.883-2.542m-16.5 0V6.226c0-1.721 1.04-3.226 2.624-3.226h4.125a2.25 2.25 0 0 1 2.25 2.25v.003l.001.006a2.25 2.25 0 0 1 2.25-2.25h4.125c1.584 0 2.624 1.505 2.624 3.226v3.55M16.5 18h-9" /></svg>
            </button>
        </div>
      </div>
    </div>
    <input type="file" id="importFile" accept=".json" class="hidden">
    
    <div class="video-container">
      <video id="player" controls controlsList="nodownload" poster="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 9'%3E%3Crect width='16' height='9' fill='%23000'/%3E%3C/svg%3E">
        <track id="subtitleTrack" kind="subtitles" srclang="id" label="Indonesia">
      </video>
    </div>

    <div class="playlist-container">
      <div class="playlist" id="playlist"></div>
    </div>

    <div id="hidden-video-container" class="hidden"></div>
  </div>

  <div class="modal-overlay" id="editModal">
    <div class="modal">
      <h2 id="modalTitle">Tambah Video Baru</h2>
      <form class="modal-form" id="modalForm">
        <input type="hidden" id="modalEditIndex">
        <div class="form-group">
          <label for="modalTitleInput">Judul Video</label>
          <input type="text" id="modalTitleInput" required>
        </div>
        <div class="form-group">
          <label for="modalUrlInput">URL Video</label>
          <input type="url" id="modalUrlInput" required>
        </div>
        <div class="form-group">
          <label for="modalSubInput">URL Subtitle (opsional)</label>
          <input type="url" id="modalSubInput">
        </div>
        <div class="form-group">
          <label for="modalThumbInput">URL Thumbnail (opsional, kosongkan untuk auto-generate)</label>
          <input type="url" id="modalThumbInput">
        </div>
        <div class="modal-actions">
          <button type="button" class="btn-secondary" id="modalCancelBtn">Batal</button>
          <button type="submit" class="btn-primary">Simpan</button>
        </div>
      </form>
    </div>
  </div>

  <div id="toast-container" class="toast-container"></div>

  <footer>Dibuat oleh meekymouse team</footer>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    /* ================== KONFIGURASI ================== */
    const CONFIG_FOLDER = "https://raw.githubusercontent.com/joker63-in/Config/refs/heads/main/vidio.json";
    const LOCAL_STORAGE_KEY = "proVideoPlaylist";

    /* ================== DOM ELEMENTS ================== */
    const player = document.getElementById('player');
    const subtitleTrack = document.getElementById('subtitleTrack');
    const playlistContainer = document.getElementById('playlist');
    const hiddenVideoContainer = document.getElementById('hidden-video-container');
    const importFileInput = document.getElementById('importFile');
    
    // Inputs
    const videoUrlInput = document.getElementById('videoUrlInput');
    const subtitleUrlInput = document.getElementById('subtitleUrlInput');

    // Buttons
    const addToPlaylistBtn = document.getElementById('addToPlaylistBtn');
    const exportPlaylistBtn = document.getElementById('exportPlaylistBtn');
    const importPlaylistBtn = document.getElementById('importPlaylistBtn');
    const loadFromJsonFolderBtn = document.getElementById('loadFromJsonFolderBtn');
    
    // Modal
    const editModal = document.getElementById('editModal');
    const modalForm = document.getElementById('modalForm');
    const modalTitle = document.getElementById('modalTitle');
    const modalEditIndexInput = document.getElementById('modalEditIndex');
    const modalTitleInput = document.getElementById('modalTitleInput');
    const modalUrlInput = document.getElementById('modalUrlInput');
    const modalSubInput = document.getElementById('modalSubInput');
    const modalThumbInput = document.getElementById('modalThumbInput');
    const modalCancelBtn = document.getElementById('modalCancelBtn');

    /* ================== STATE MANAGEMENT ================== */
    let state = {
      playlists: [],
      currentIndex: -1,
      draggedIndex: null
    };

    const defaultPlaylist = [];
    
    /* ================== UTILITY FUNCTIONS ================== */
    const saveState = () => localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(state.playlists));
    
    const loadState = () => {
      try {
        const saved = localStorage.getItem(LOCAL_STORAGE_KEY);
        const parsed = saved ? JSON.parse(saved) : defaultPlaylist.slice();
        state.playlists = parsed.map(item => ({
          url: item.url || "",
          subtitle: item.subtitle || "",
          title: item.title || "Tanpa Judul",
          thumbnail: (typeof item.thumbnail === "string" || item.thumbnail === null) ? item.thumbnail : null
        }));
      } catch {
        state.playlists = defaultPlaylist.slice();
      }
    };
    
    const escapeHtml = (str) => String(str).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'})[m]);

    const showToast = (message, type = 'success') => {
        const toastContainer = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        toastContainer.appendChild(toast);
        setTimeout(() => {
            toast.style.animation = 'fadeOut 0.5s forwards';
            setTimeout(() => toast.remove(), 500);
        }, 3000);
    };

    /* ================== RENDER LOGIC ================== */
    function renderPlaylist() {
      playlistContainer.innerHTML = "";

      if (state.playlists.length === 0) {
        playlistContainer.innerHTML = `
          <div class="playlist-empty">
            <div class="playlist-empty-icon">ðŸ“¼</div>
            <div class="playlist-empty-text">Playlist Anda kosong. Tambahkan video untuk memulai.</div>
          </div>`;
        return;
      }

      state.playlists.forEach((item, index) => {
        const itemEl = document.createElement("div");
        itemEl.className = "playlist-item";
        itemEl.dataset.index = index;
        itemEl.draggable = true;
        if (index === state.currentIndex) {
          itemEl.classList.add("is-playing");
        }
        
        const thumbSrc = (item.thumbnail && item.thumbnail !== "failed")
          ? item.thumbnail
          : "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";

        itemEl.innerHTML = `
          <img id="thumb-${index}" class="playlist-thumbnail" src="${thumbSrc}" alt="Thumbnail ${escapeHtml(item.title)}" data-action="play">
          <div class="playlist-text" title="${escapeHtml(item.title)}" data-action="play">
            ${escapeHtml(item.title)}
          </div>
          <div class="actions">
            <button class="edit" title="Edit" data-action="edit">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"></path></svg>
            </button>
            <button class="delete" title="Hapus" data-action="delete">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"></path></svg>
            </button>
          </div>
        `;
        playlistContainer.appendChild(itemEl);

        if (item.thumbnail === null) {
          generateThumbnail(index);
        }
      });
    }
    
    /* ================== CORE PLAYER LOGIC ================== */
    function playVideo(index) {
      if (index < 0 || index >= state.playlists.length) return;
      
      const item = state.playlists[index];
      state.currentIndex = index;
      
      player.poster = document.getElementById(`thumb-${index}`)?.src || "";
      player.src = item.url || "";
      subtitleTrack.src = item.subtitle || "";
      
      player.load();
      player.play().catch(() => {
        player.muted = true;
        player.play().catch(err => console.error("Autoplay failed:", err));
      });

      player.scrollIntoView({ behavior: 'smooth', block: 'center' });
      renderPlaylist();
    }
    
    /* ================== PLAYLIST CRUD & MODAL ================== */
    function openModalForEdit(index) {
      const item = state.playlists[index];
      modalTitle.textContent = "Edit Video";
      modalEditIndexInput.value = index;
      modalTitleInput.value = item.title;
      modalUrlInput.value = item.url;
      modalSubInput.value = item.subtitle;
      modalThumbInput.value = (item.thumbnail && item.thumbnail.startsWith('http')) ? item.thumbnail : '';
      editModal.classList.add('is-visible');
    }

    function openModalForAdd() {
      modalTitle.textContent = "Tambah Video Baru";
      modalForm.reset();
      modalEditIndexInput.value = -1;
      
      modalUrlInput.value = videoUrlInput.value.trim();
      modalSubInput.value = subtitleUrlInput.value.trim();
      modalTitleInput.value = `Video Baru ${state.playlists.length + 1}`;
      
      editModal.classList.add('is-visible');
      modalTitleInput.focus();
      modalTitleInput.select();
    }
    
    function closeModal() {
      editModal.classList.remove('is-visible');
    }

    function handleFormSubmit(e) {
      e.preventDefault();
      const index = parseInt(modalEditIndexInput.value, 10);
      const url = modalUrlInput.value.trim();
      if (!url) {
          showToast("URL video tidak boleh kosong!", 'error');
          return;
      }
      
      const newItemData = {
        title: modalTitleInput.value || "Tanpa Judul",
        url: url,
        subtitle: modalSubInput.value.trim(),
        thumbnail: modalThumbInput.value.trim() || null,
      };

      if (index > -1) {
        state.playlists[index] = { ...state.playlists[index], ...newItemData };
        showToast("Video berhasil diperbarui.");
      } else {
        state.playlists.push(newItemData);
        videoUrlInput.value = "";
        subtitleUrlInput.value = "";
        showToast("Video berhasil ditambahkan.");
      }
      
      saveState();
      renderPlaylist();
      closeModal();
      
      if (index === -1) {
        playVideo(state.playlists.length - 1);
      }
    }
    
    function deletePlaylist(index) {
        if (!confirm("Anda yakin ingin menghapus video ini dari playlist?")) return;
        state.playlists.splice(index, 1);
        if (state.currentIndex === index) {
            state.currentIndex = -1;
        } else if (state.currentIndex > index) {
            state.currentIndex--;
        }
        saveState();
        renderPlaylist();
        showToast("Video telah dihapus.");
    }

    /* ================== THUMBNAIL & I/O ================== */
    function generateThumbnail(index) {
        const item = state.playlists[index];
        if (!item || !item.url) return;
        const video = document.createElement("video");
        video.crossOrigin = "anonymous";
        const onSeeked = () => {
          const canvas = document.createElement("canvas");
          canvas.width = 120;
          canvas.height = (video.videoHeight / video.videoWidth) * 120 || 68;
          canvas.getContext("2d").drawImage(video, 0, 0, canvas.width, canvas.height);
          const dataUrl = canvas.toDataURL("image/jpeg");
          state.playlists[index].thumbnail = dataUrl;
          const img = document.getElementById(`thumb-${index}`);
          if (img) img.src = dataUrl;
          saveState();
          video.remove();
        };
        const onError = () => {
          state.playlists[index].thumbnail = "failed";
          saveState();
          video.remove();
        };
        video.addEventListener("seeked", onSeeked, { once: true });
        video.addEventListener("error", onError, { once: true });
        video.addEventListener("loadeddata", () => video.currentTime = 1, { once: true });
        video.preload = "metadata";
        video.src = item.url;
        hiddenVideoContainer.appendChild(video);
    }
    
    function exportPlaylist() {
      if (!state.playlists.length) return showToast("Playlist kosong, tidak ada yang diekspor.", 'error');
      const dataStr = JSON.stringify(state.playlists, null, 2);
      const blob = new Blob([dataStr], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "playlist.json";
      a.click();
      URL.revokeObjectURL(url);
      a.remove();
      showToast("Playlist diekspor sebagai playlist.json");
    }

    function handleFileSelect(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          if (!confirm("Ini akan menimpa playlist saat ini. Lanjutkan?")) return;
          applyConfigArray(data);
        } catch (err) {
          showToast("Gagal membaca file. Pastikan JSON valid.", "error");
        }
      };
      reader.readAsText(file);
      event.target.value = null;
    }

    /* ================== MUAT CONFIG JSON ================== */
    function applyConfigArray(data) {
        if (!Array.isArray(data)) {
          showToast("Format JSON tidak valid (harus berupa array).", "error");
          return;
        }
        state.playlists = data.map(item => ({
            url: item.url || "",
            subtitle: item.subtitle || "",
            title: item.title || "Tanpa Judul",
            thumbnail: item.thumbnail || null
        }));
        saveState();
        renderPlaylist();
        if (state.playlists.length) playVideo(0);
        showToast("Playlist dari file JSON berhasil dimuat.");
    }
    
    // ===================================================================
    // KODE YANG DIPERBAIKI ADA DI FUNGSI DI BAWAH INI
    // ===================================================================
    function loadFromJsonFolder() {
      // Selalu coba fetch dari server terlebih dahulu.
      fetch(CONFIG_FOLDER)
        .then(res => {
          // Jika respons tidak OK (misal: 404 Not Found), lempar error untuk ditangkap .catch()
          if (!res.ok) {
            throw new Error(`Server response: ${res.status}`);
          }
          return res.json();
        })
        .then(data => {
          // Jika berhasil, tanyakan pengguna sebelum menimpa playlist
          if (confirm("File movie.json ditemukan di server. Timpa playlist saat ini?")) {
            applyConfigArray(data);
          }
        })
        .catch(error => {
          // .catch() ini akan menangani SEMUA jenis kegagalan:
          // 1. Gagal fetch karena dijalankan sebagai `file://` (dilarang browser)
          // 2. Gagal karena file tidak ada di server (404 Not Found)
          // 3. Gagal karena file JSON tidak valid
          // 4. Masalah jaringan lainnya
          console.error("Gagal memuat otomatis:", error.message);
          showToast("Gagal muat otomatis, pilih file manual.", "error");
          // Sebagai alternatif (fallback), buka file manager
          importFileInput.click();
        });
    }

    /* ================== EVENT LISTENERS ================== */
    addToPlaylistBtn.addEventListener('click', openModalForAdd);
    exportPlaylistBtn.addEventListener('click', exportPlaylist);
    importPlaylistBtn.addEventListener('click', () => importFileInput.click());
    importFileInput.addEventListener('change', handleFileSelect);
    loadFromJsonFolderBtn.addEventListener('click', loadFromJsonFolder);

    playlistContainer.addEventListener('click', (e) => {
        const target = e.target.closest('[data-action]');
        if (!target) return;
        const action = target.dataset.action;
        const itemEl = target.closest('.playlist-item');
        const index = parseInt(itemEl.dataset.index, 10);
        if(isNaN(index)) return;

        switch(action) {
            case 'play': playVideo(index); break;
            case 'edit': openModalForEdit(index); break;
            case 'delete': deletePlaylist(index); break;
        }
    });

    modalForm.addEventListener('submit', handleFormSubmit);
    modalCancelBtn.addEventListener('click', closeModal);
    editModal.addEventListener('click', (e) => {
      if (e.target === editModal) closeModal();
    });
    
    player.addEventListener('ended', () => {
        const nextIndex = state.currentIndex + 1;
        if (nextIndex < state.playlists.length) {
            playVideo(nextIndex);
        }
    });

    // Drag & Drop
    playlistContainer.addEventListener('dragstart', e => {
        const itemEl = e.target.closest('.playlist-item');
        if (itemEl) {
            state.draggedIndex = parseInt(itemEl.dataset.index, 10);
            e.dataTransfer.effectAllowed = 'move';
            setTimeout(() => itemEl.classList.add('is-dragging'), 0);
        }
    });

    playlistContainer.addEventListener('dragover', e => {
        e.preventDefault();
        const targetItem = e.target.closest('.playlist-item');
        if (targetItem && parseInt(targetItem.dataset.index, 10) !== state.draggedIndex) {
            const rect = targetItem.getBoundingClientRect();
            const isAfter = e.clientY > rect.top + rect.height / 2;
            const draggedItem = playlistContainer.querySelector('.is-dragging');
            if(!draggedItem) return;
            
            if (isAfter) {
                targetItem.parentNode.insertBefore(draggedItem, targetItem.nextSibling);
            } else {
                targetItem.parentNode.insertBefore(draggedItem, targetItem);
            }
        }
    });

    playlistContainer.addEventListener('dragend', e => {
        const draggedEl = e.target.closest('.playlist-item');
        if (draggedEl) {
            draggedEl.classList.remove('is-dragging');
            state.draggedIndex = null;
        }
    });

    playlistContainer.addEventListener('drop', e => {
        e.preventDefault();
        if (state.draggedIndex === null) return;

        const newOrderIndices = Array.from(playlistContainer.querySelectorAll('.playlist-item'))
            .map(item => parseInt(item.dataset.index, 10));
        
        const newPlaylists = newOrderIndices.map(index => state.playlists[index]);
        state.playlists = newPlaylists;

        const currentlyPlayingItem = state.currentIndex !== -1 ? state.playlists[state.currentIndex] : null;

        saveState();
        renderPlaylist(); // Re-render to update dataset.index correctly for all items
        
        // After re-rendering, find the new index of the currently playing item
        if (currentlyPlayingItem) {
          const newCurrentIndex = state.playlists.findIndex(item => item.url === currentlyPlayingItem.url);
          state.currentIndex = newCurrentIndex;
          // Re-apply the 'is-playing' class without a full re-render
          const playingEl = playlistContainer.querySelector(`.playlist-item[data-index='${newCurrentIndex}']`);
          if(playingEl) playingEl.classList.add('is-playing');
        }

        showToast("Playlist diurutkan ulang.");
    });

    /* ================== INITIALIZATION ================== */
    loadState();
    renderPlaylist();
    
  });
  </script>
</body>
</html>
